<html>

<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
<script src="load-image-min.js"></script>
<script>
    $(document).ready(function(){
        console.log('ahoj');
        $('#div').on(
                'dragover',
                function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
        )
        $('#div').on(
                'dragenter',

                function(e) {
                    //console.log(e);
                    e.preventDefault();
                    e.stopPropagation();
                }
        )

        $('#div').on(
                'drop',
                function(e){
                    e.preventDefault();
                    e.stopPropagation();
                    console.log(e);

                    if(e.originalEvent.dataTransfer.items){
                        console.log(e.originalEvent.dataTransfer.items, e.originalEvent.dataTransfer.items.length);

                        if(e.originalEvent.dataTransfer.items.length == 1){
                            e.originalEvent.dataTransfer.items[0].getAsString(function(url){
//                        var obj = jQuery(url);



                                //previewFromFile(src);

                                loadImageFromResource(url);
                                console.log(1, url);
                            });
                        }



                        if(e.originalEvent.dataTransfer && e.originalEvent.dataTransfer.items.length > 1){
                            e.originalEvent.dataTransfer.items[1].getAsString(function(url){

                                var obj = jQuery(url);
                                var src = obj.attr('src');

                                var fr = new FileReader();

                                fr.onload = function(data){
                                   console.log(21, data);
                                };



                                console.log(2, url);


                                //previewFromFile(src);
                                if(src.indexOf('http://') == 0 || src.indexOf('https://') == 0){
                                    saveImgUrl(src);
                                } else {
                                    uploadData(src);
                                }


                                //$('#div').attr('src',src);
                                //console.log(url);
                            });
                        }


                        if(e.originalEvent.dataTransfer){
                            if(e.originalEvent.dataTransfer.files.length) {

                                var f = e.originalEvent.dataTransfer.files[0];

                                previewFromFile(f);
                                console.log(3,f);
                                /*UPLOAD FILES HERE*/
                                //upload(e.originalEvent.dataTransfer.files);
                            }
                        }
                    }



                }


        );


        function saveImgUrl(url){


            var fd = new FormData();
            fd.append("link", 1007);
            fd.append("url", url);;
            $.ajax({
                type: 'POST',
                url: '/words/saveimgurl',
                data: fd,
                processData: false,
                contentType: false,
                    success : function(data, status, headers, config) {
                        console.log(data);
                        loadImageFromResource(data);
                    },
                    error:function(data, status, headers, config) {
                        // called asynchronously if an error occurs
                        // or server returns response with an error status.
                    }
            });


        }

        function uploadData(res){
            var data = res.split(',');
            var fd = new FormData();
            fd.append("link", 1007);
            fd.append("file", data[1]);
            fd.append("type", data[0].split(';')[0]);

            $.ajax({
                url: "/words/uploadimg",
                type: "POST",
                data: fd,
                processData: false,
                contentType: false,
                success: function(response) {
                    // .. do something
                    console.log(response);

                    loadImageFromResource(response);
                },
                error: function(jqXHR, textStatus, errorMessage) {
                    console.log(errorMessage); // Optional
                }
            });
        }


        function loadImageFromResource(res){

            // CANVAS error CROS image data

            if(res.length){
                res.forEach(function(val, idx){
                    if(val.version == 0){
                        var src = '/assets/img/' + val.image;
                        $('#div').attr('src',src);
                        console.log('src', src);
                    }
                });


            }



        }

        function previewFromFile(f){
            var reader = new FileReader(f);

            //attach event handlers here...
            reader.onload = function (ef) {
                uploadData(ef.target.result);
            }

            reader.onerror = function(err){
                console.log(err);
            }

            reader.readAsDataURL(f);
        }

        $('#file1').on('change',function ()
        {

            previewFromFile(this.files[0]);
//            var filePath = 'file:///' +  $(this).val();
//            $('#div').attr('src',filePath);
            console.log(this.files[0]);
        });


    })


</script>
<style>

.drag-drop{
    border:#000088;
    border-style: dashed;
    width:400px;
    height:400px;
}
    #myCanvas2{
        background-color:black;
    }
</style>

<body>


    <input type="file" id="file1"/>
<img id="div" src="http://borderka-enny.websnadno.cz/ahoj.JPG"  class="drag-drop" />

    <div id="container"></div>
    <div>
        widtht&height : <span id="width" />
    </div>

    <canvas id="myCanvas" width="578" height="200"></canvas>
    <canvas id="myCanvas2" width="578" height="400"></canvas>
    </body>


</html>